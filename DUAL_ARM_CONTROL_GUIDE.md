# 双臂控制模式选择功能

## 概述

这个新功能为机器人控制面板添加了双臂控制模式选择，允许用户为左臂和右臂独立选择不同的控制方式。

## 控制模式

### 1. MoveIt! 规划控制
- **特点**: 使用运动规划算法，自动避障，轨迹平滑
- **优势**: 安全性高，能避免碰撞，运动轨迹优化
- **适用场景**: 复杂环境下的精确操作，需要避障的任务
- **话题**: `/move_group` (MoveIt! Action Server)

### 2. 直接关节角控制
- **特点**: 直接发送关节角指令，快速响应
- **优势**: 响应速度快，延迟低，控制精确
- **适用场景**: 简单环境下的快速操作，需要实时控制的任务
- **话题**: 
  - 左臂: `/l_arm/rm_driver/MoveJ_Cmd`
  - 右臂: `/r_arm/rm_driver/MoveJ_Cmd`

## 使用方法

### 前端界面操作

1. **选择控制模式**
   - 在每个机械臂控制卡片的顶部，您会看到控制模式选择器
   - 可以选择 "MoveIt! 规划控制" 或 "直接关节角控制"
   - 左臂和右臂可以独立选择不同的控制模式

2. **发送控制指令**
   - 调整关节角度滑块到期望位置
   - 点击对应的"发送左臂指令"或"发送右臂指令"按钮
   - 系统会根据选择的控制模式自动使用相应的控制方法

3. **双臂归位功能**
   - 点击"双臂归位"按钮时，系统会根据每个臂的当前控制模式
   - 分别使用相应的控制方法将机械臂移动到归位位置

### 配置参数

在 `config.py` 中的相关配置：

```python
# 控制模式定义
ARM_CONTROL_MODES = {
    'moveit': 'MoveIt! 规划控制',
    'direct': '直接关节角控制'
}

# 默认控制模式
DEFAULT_ARM_CONTROL_MODE = 'moveit'

# 直接控制参数
JOINT_CONTROL_SPEED = 0.5  # 运动速度 (0.0-1.0)
JOINT_CONTROL_TRAJECTORY_CONNECT = 0  # 轨迹连接标志
```

## 反馈信息

系统会在操作反馈区域显示详细的状态信息：

- **MoveIt! 模式**: 显示规划和执行状态
- **直接控制模式**: 显示指令发送状态和目标角度
- **双臂归位**: 显示每个臂使用的控制模式和目标位置

## 安全注意事项

### MoveIt! 控制
- ✅ 自动避障，相对安全
- ✅ 轨迹规划优化
- ⚠️ 规划可能失败，需要检查环境

### 直接关节控制
- ⚠️ **高风险**: 不进行碰撞检测
- ⚠️ 确保工作空间清空，无障碍物
- ⚠️ 建议先使用小幅度运动测试
- ⚠️ 始终准备好急停按钮

## 故障排除

### 常见问题

1. **MoveIt! 控制失败**
   - 检查 MoveIt! 服务是否运行
   - 确认规划组配置正确
   - 检查目标位置是否可达

2. **直接控制无响应**
   - 检查ROS Bridge连接
   - 确认话题名称正确
   - 检查机械臂驱动程序状态

3. **控制模式切换问题**
   - 刷新浏览器页面
   - 检查前端JavaScript控制台错误

### 调试工具

运行测试脚本检查功能：

```bash
cd /path/to/RobotDashboard
python test_dual_arm_control.py
```

## 技术实现

### 前端组件 (`components/layout.py`)
- 添加了控制模式选择器（RadioItems）
- 每个机械臂独立的模式选择

### 回调处理 (`callbacks/ui_callbacks.py`)
- 修改了控制指令发送逻辑
- 根据选择的模式调用不同的控制函数
- 更新了双臂归位功能

### ROS通信 (`ros_comms/handler.py`)
- 新增直接关节角控制函数：
  - `send_direct_joint_command()`
  - `send_left_arm_direct_command()`
  - `send_right_arm_direct_command()`

## 版本信息

- **版本**: 1.0
- **更新日期**: 2024年6月
- **兼容性**: 支持现有的MoveIt!配置，向后兼容

## 未来改进

- [ ] 添加控制模式的实时状态指示
- [ ] 支持混合控制模式（部分关节使用MoveIt!，部分直接控制）
- [ ] 添加安全检查和限位保护
- [ ] 实现控制模式的快速切换快捷键
